---
- name: Check the latest Neovim version
  ansible.builtin.uri:
    url: https://api.github.com/repos/neovim/neovim/releases/latest
    return_content: yes
  register: latest_release

- name: Extract the latest version tag
  ansible.builtin.set_fact:
    latest_version: "{{ latest_release.json.tag_name }}"

- name: Check if Neovim is installed in /opt (release tarball layout)
  ansible.builtin.stat:
    path: /opt/nvim-linux-x86_64/bin/nvim
  register: nvim_bin

- name: Check the installed Neovim version (/opt)
  ansible.builtin.shell: "/opt/nvim-linux-x86_64/bin/nvim --version | head -n 1 | awk '{print $2}'"
  register: installed_version
  failed_when: false
  changed_when: false
  when: nvim_bin.stat.exists

- name: Download/install Neovim if missing or outdated
  become: yes
  ansible.builtin.shell: |
    curl -fL -o nvim-linux-x86_64.tar.gz https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
    rm -rf /opt/nvim-linux-x86_64
    tar -C /opt -xzf nvim-linux-x86_64.tar.gz
  args:
    chdir: /tmp
  when: not nvim_bin.stat.exists or (installed_version.stdout | default('') | trim) != latest_version

- name: Ensure nvim is on PATH (/usr/local/bin/nvim)
  become: yes
  ansible.builtin.file:
    src: /opt/nvim-linux-x86_64/bin/nvim
    dest: /usr/local/bin/nvim
    state: link

- name: Check if tree-sitter-cli is installed (Homebrew)
  ansible.builtin.stat:
    path: /home/linuxbrew/.linuxbrew/bin/tree-sitter
  register: treesitter_cli

- name: Install tree-sitter-cli with brew
  become: no
  ansible.builtin.shell: /home/linuxbrew/.linuxbrew/bin/brew install tree-sitter-cli
  when: not treesitter_cli.stat.exists
