
- name: Ensure UFW is installed
  apt:
    name: ufw
    state: present

- name: Reset UFW to deny all (Safety first)
  ufw:
    state: reset

- name: Allow Tailscale traffic
  ufw:
    rule: allow
    src: 100.64.0.0/10

- name: Allow traffic from local network
  ufw:
    rule: allow
    src: 192.168.1.0/24

- name: Allow DNS traffic (Pi-hole)
  ufw:
    rule: allow
    port: '53'
    proto: "{{ item }}"
  loop:
    - tcp
    - udp

- name: Allow SSH
  ufw:
    rule: allow
    port: '22'
    proto: tcp

# RIMOSSE REGOLE 80 E 443: Il tunnel non ne ha bisogno.
# Se le lasci, chiunque conosca il tuo IP entra bypassando Cloudflare.

- name: Enable UFW
  ufw:
    state: enabled
    policy: deny
